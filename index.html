<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>„Å∏„ÉºÔºÅ„É©„Ç§„Éñ„É≠„Ç∞ Ôºã ÈõÜË®à</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background:#f7fafc; margin:0; padding:24px; color:#111; }
    h1 { text-align:center; margin-bottom:18px; }
    .container { max-width:980px; margin:0 auto; display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; }

    /* LEFT: buttons + chat log */
    .panel { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(20,20,40,0.06); }
    #buttons { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    .member-btn {
      padding:10px 14px; border-radius:10px; border:none; cursor:pointer;
      background:linear-gradient(135deg,#7fd3d0,#7fb8ff); color:#042; font-weight:600;
      box-shadow:0 4px 10px rgba(40,60,90,0.06);
    }
    .member-btn:active { transform:translateY(1px); }

    /* chat log */
    #log { height:520px; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3f8; }
    .log-item { padding:8px; margin-bottom:6px; border-radius:8px; background:linear-gradient(180deg,#ffffff,#f1f8ff); box-shadow:0 1px 0 rgba(0,0,0,0.02); }
    .log-meta { font-size:12px; color:#6b7280; margin-bottom:4px; }
    .log-text { font-size:15px; color:#0f172a; }

    /* RIGHT: aggregate (fixed-order list) */
    .agg-title { margin-bottom:8px; font-weight:700; }
    #aggregate { display:flex; flex-direction:column; gap:8px; }
    .agg-row { display:flex; align-items:center; gap:8px; padding:10px; border-radius:8px; background:#fff; border:1px solid #eef3f8; }
    .agg-name { width:110px; font-weight:600; }
    .agg-bar-bg { flex:1; height:12px; background:#eef2ff; border-radius:999px; overflow:hidden; }
    .agg-bar { height:100%; background:linear-gradient(90deg,#60d394,#54a0ff); }
    .agg-count { width:44px; text-align:right; font-weight:700; color:#0b1220; }

    /* responsive */
    @media (max-width:920px) {
      .container { grid-template-columns: 1fr; }
      #log { height:360px; }
    }
  </style>
</head>
<body>
  <h1>„Å∏„ÉºÔºÅ ‚Äî „É©„Ç§„Éñ„É≠„Ç∞ ÔºÜ ÈõÜË®à</h1>

  <div class="container">
    <!-- LEFT: buttons + log -->
    <div class="panel">
      <div id="buttons"></div>
      <div style="font-weight:700; margin-bottom:8px;">Áõ¥Ëøë„É≠„Ç∞</div>
      <div id="log"></div>
    </div>

    <!-- RIGHT: aggregate fixed-order -->
    <div class="panel">
      <div class="agg-title">ÈõÜË®àÔºàÂõ∫ÂÆöÈ†ÜÔºâ</div>
      <div id="aggregate"></div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    // --- Firebase libs (modular) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, updateDoc,
      onSnapshot, addDoc, serverTimestamp, query, orderBy, limit, increment
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";


    // üîπ „ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö„Çí„Åì„Åì„Å´„Ç≥„Éî„ÉöÔºÅ
    const firebaseConfig = {
      apiKey: "AIzaSyAr8etX574HAPKISDxjGNFru_WrFcNthHo",
      authDomain: "hee-counter-1.firebaseapp.com",
      projectId: "hee-counter-1",
      storageBucket: "hee-counter-1.firebasestorage.app",
      messagingSenderId: "487272221928",
      appId: "1:487272221928:web:48f40b93de7acbb8800d5d"
    };


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ÈÉ®Âì°„É™„Çπ„ÉàÔºàÂõ∫ÂÆöÔºâ
    const members = [
      { id: "m1", name: "‰∏âÊµ¶„Åï„Çì" },
      { id: "m2", name: "Âø´Âπ≥„Åï„Çì" },
      { id: "m3", name: "‰Ωê„ÄÖÊú®„Åï„Çì" },
      { id: "m4", name: "ÂúíÁî∞„Åï„Çì" },
      { id: "m5", name: "Ê∏ãË∞∑„Åï„Çì" },
      { id: "m6", name: "Â∑•Ëó§„Åï„Çì" },
      { id: "m7", name: "ÂÆÆÔ®ë„Åï„Çì" },
      { id: "m8", name: "Â†ÄÁî∞„Åï„Çì" },
      { id: "m9", name: "ÁßãÂ±±„Åï„Çì" },
      { id: "m10", name: "ÈöÖÁî∞„Åï„Çì" },
      { id: "m11", name: "Êùé„Åï„Çì" }
    ];

    const buttonsDiv = document.getElementById("buttons");
    const rankingList = document.getElementById("ranking-list");

    // DOM refs
    const buttonsRoot = document.getElementById("buttons");
    const logRoot = document.getElementById("log");
    const aggRoot = document.getElementById("aggregate");

    // --- ÂàùÊúüÂåñÔºömembers „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´ doc „ÅåÁÑ°„Åë„Çå„Å∞‰Ωú„ÇãÔºàcount:0Ôºâ ---
    async function ensureMembersExist() {
      for (const m of members) {
        const ref = doc(db, "members", m.id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, { name: m.name, count: 0 });
        }
      }
    }
    ensureMembersExist().catch(console.error);

    // --- UI: „Éú„Çø„É≥„Çí‰Ωú„ÇãÔºàÊäº„Åô„Å® count++ „Å® logs „Å∏1Ë°åËøΩÂä†Ôºâ ---
    members.forEach(m => {
      const btn = document.createElement("button");
      btn.className = "member-btn";
      btn.textContent = `${m.name}„Äå„Å∏„ÉºÔºÅ„Äç`;
      btn.addEventListener("click", async () => {
        try {
          // 1) members/{id}.count „Çí„Ç§„É≥„ÇØ„É™„É°„É≥„ÉàÔºàÂÆâÂÖ®„Å´Ôºâ
          const ref = doc(db, "members", m.id);
          await updateDoc(ref, { count: increment(1) });

          // 2) logs „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´ËøΩÂä†ÔºàÊôÇÂàª„Å®ÂêçÂâç„ÇíË®òÈå≤Ôºâ
          await addDoc(collection(db, "logs"), {
            memberId: m.id,
            name: m.name,
            createdAt: serverTimestamp()
          });
        } catch (err) {
          console.error("Êäº‰∏ãÂá¶ÁêÜ„Ç®„É©„Éº:", err);
        }
      });
      buttonsRoot.appendChild(btn);
    });

    // --- „É™„Ç¢„É´„Çø„Ç§„É†Ôºölogs „ÇíÁõ£Ë¶ñ„Åó„Å¶„ÉÅ„É£„ÉÉ„ÉàÈ¢®„Å´Ë°®Á§∫ ---
    // ÊúÄÊñ∞50‰ª∂ÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ„ÇíÁõ£Ë¶ñ
    const logsQuery = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
    onSnapshot(logsQuery, (snapshot) => {
      // snapshot„ÅØÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ„Å™„ÅÆ„Åß„ÄÅË°®Á§∫„ÅØÈÄÜ„Å´„Åó„Å¶‰∏ä„Åã„ÇâÊñ∞„Åó„ÅèË¶ã„Åõ„Çã or ‰∏ã„Å´ËøΩÂä†„Åô„Çã„ÅãÈÅ∏„Åπ„Çã„ÄÇ
      // „Åì„Åì„Åß„ÅØ„Äå‰∏ä„Å´Êñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„ÅåÊù•„Çã„Äç„Çπ„Çø„Ç§„É´„ÅßÊñ∞„Åó„ÅÑÈ†Ü„Å´Ë°®Á§∫„ÄÇ
      logRoot.innerHTML = ""; // clear
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        // createdAt may be null for recently added before serverTimestamp resolves; handle gracefully:
        const ts = data.createdAt ? new Date(data.createdAt.toMillis()).toLocaleTimeString() : "‚Äî";
        const div = document.createElement("div");
        div.className = "log-item";
        div.innerHTML = `<div class="log-meta">${data.name} ¬∑ ${ts}</div><div class="log-text">„Å∏„ÉºÔºÅ</div>`;
        logRoot.appendChild(div);
      });
    });

    // --- „É™„Ç¢„É´„Çø„Ç§„É†Ôºömembers „ÇíÁõ£Ë¶ñ„Åó„Å¶ÈõÜË®àÔºàÂõ∫ÂÆöÈ†ÜÔºâ„ÇíË°®Á§∫ ---
    // We'll keep a local map of counts for quick lookups.
    const membersMap = new Map();
    // initialize from Firestore snapshot of collection
    onSnapshot(collection(db, "members"), (snap) => {
      snap.forEach(d => {
        membersMap.set(d.id, d.data().count ?? 0);
      });
      renderAggregate();
    });

    // Render aggregate list in the fixed members order
    function renderAggregate() {
      aggRoot.innerHTML = "";
      // Determine maximum count for bar scaling
      let max = 1;
      for (const m of members) {
        const c = membersMap.get(m.id) ?? 0;
        if (c > max) max = c;
      }
      for (const m of members) {
        const count = membersMap.get(m.id) ?? 0;
        // make row
        const row = document.createElement("div");
        row.className = "agg-row";
        // name
        const nameEl = document.createElement("div");
        nameEl.className = "agg-name";
        nameEl.textContent = m.name;
        // bar bg + bar
        const barBg = document.createElement("div");
        barBg.className = "agg-bar-bg";
        const bar = document.createElement("div");
        bar.className = "agg-bar";
        const pct = Math.round((count / max) * 100);
        bar.style.width = pct + "%";
        // color accent for top 3 by current counts (optional)
        // compute rank by scanning ordered counts quickly
        // (We'll color by value: first three highest coloured)
        row.appendChild(nameEl);
        barBg.appendChild(bar);
        row.appendChild(barBg);
        const countEl = document.createElement("div");
        countEl.className = "agg-count";
        countEl.textContent = String(count);
        row.appendChild(countEl);
        aggRoot.appendChild(row);
      }
    }

    // Helpful: scroll log to top when new entries appear (newest at top)
    // The onSnapshot for logs re-renders all; ensure it's scrolled to top
    onSnapshot(query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(1)), () => {
      // small timeout to let DOM update
      setTimeout(() => { if (logRoot) logRoot.scrollTop = 0; }, 50);
    });

    // Done
    console.log("„É©„Ç§„Éñ„É≠„Ç∞ÔºãÈõÜË®à UI ÂàùÊúüÂåñÂÆå‰∫Ü");
  </script>
</body>
</html>

